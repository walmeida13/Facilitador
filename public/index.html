<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facilitador - Conversor PDF/DOCX para Markdown</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfjs-dist/3.11.174/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mammoth@1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.4/dist/tesseract.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .badge {
            display: inline-block;
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 15px;
            border-radius: 20px;
            margin-top: 10px;
            font-size: 0.9em;
        }

        .content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 30px;
        }

        @media (max-width: 1024px) {
            .content {
                grid-template-columns: 1fr;
            }
        }

        .section {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .section h2 {
            font-size: 1.5em;
            color: #333;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9ff;
        }

        .upload-area:hover {
            background: #f0f2ff;
            border-color: #764ba2;
        }

        .upload-area.dragover {
            background: #e8ebff;
            border-color: #764ba2;
            transform: scale(1.02);
        }

        .upload-area input[type="file"] {
            display: none;
        }

        .upload-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .upload-text {
            color: #666;
            font-size: 1.1em;
            margin-bottom: 5px;
        }

        .upload-hint {
            color: #999;
            font-size: 0.9em;
        }

        .file-list {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: white;
            border-radius: 5px;
            margin-bottom: 8px;
            border-left: 4px solid #667eea;
        }

        .file-info {
            flex: 1;
        }

        .file-name {
            font-weight: bold;
            color: #333;
        }

        .file-size {
            font-size: 0.85em;
            color: #999;
        }

        .file-remove {
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 1.2em;
            transition: all 0.3s ease;
        }

        .file-remove:hover {
            background: #ff5252;
            transform: scale(1.1);
        }

        .progress-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            display: none;
        }

        .progress-section.active {
            display: block;
        }

        .progress-bar {
            width: 100%;
            height: 25px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.9em;
        }

        .status-text {
            color: #666;
            font-size: 0.95em;
            line-height: 1.5;
        }

        .status-text.info {
            color: #667eea;
        }

        .status-text.success {
            color: #51cf66;
        }

        .status-text.warning {
            color: #ffa500;
        }

        .status-text.error {
            color: #ff6b6b;
        }

        .buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        button {
            flex: 1;
            min-width: 150px;
            padding: 12px 24px;
            font-size: 1em;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #d0d0d0;
        }

        .btn-danger {
            background: #ff6b6b;
            color: white;
        }

        .btn-danger:hover {
            background: #ff5252;
        }

        .preview {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
            color: #333;
        }

        .preview:empty::before {
            content: 'üìÑ Preview do Markdown aparecer√° aqui...';
            color: #999;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-close {
            float: right;
            font-size: 2em;
            cursor: pointer;
            color: #666;
        }

        .privacy-badge {
            display: inline-block;
            background: #51cf66;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            cursor: pointer;
            margin-top: 15px;
        }

        .footer {
            background: #f8f9fa;
            padding: 20px;
            text-align: center;
            border-top: 1px solid #e0e0e0;
            color: #666;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-box {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            border-left: 4px solid #667eea;
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 0.85em;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Facilitador</h1>
            <p>Conversor Inteligente de PDF/DOCX para Markdown</p>
            <div class="badge">WcAlEldA - Processamento Premium com Google Cloud Vision</div>
        </div>

        <div class="content">
            <!-- Se√ß√£o de Upload -->
            <div class="section">
                <h2>üì§ Upload de Arquivos</h2>
                
                <div class="stats">
                    <div class="stat-box">
                        <div class="stat-value" id="fileCount">0</div>
                        <div class="stat-label">Arquivos</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="totalSize">0 MB</div>
                        <div class="stat-label">Tamanho Total</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="statusIcon">‚è≥</div>
                        <div class="stat-label">Status</div>
                    </div>
                </div>

                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">üìÅ</div>
                    <div class="upload-text">Arraste arquivos aqui ou clique</div>
                    <div class="upload-hint">Suporta PDF, DOCX | Ilimitado</div>
                    <input type="file" id="fileInput" multiple accept=".pdf,.docx">
                </div>

                <div class="file-list" id="fileList"></div>

                <div class="progress-section" id="progressSection">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill">0%</div>
                    </div>
                    <div class="status-text info" id="statusText">Pronto para converter...</div>
                </div>

                <div class="buttons">
                    <button class="btn-primary" id="convertBtn">üîÑ Converter para Markdown</button>
                    <button class="btn-danger" id="clearBtn">üóëÔ∏è Limpar</button>
                </div>

                <div class="privacy-badge" id="privacyBadge">üîê 100% Privado - Clique para saber mais</div>
            </div>

            <!-- Se√ß√£o de Preview -->
            <div class="section">
                <h2>üìù Preview Markdown</h2>
                <div class="preview" id="preview"></div>
                <div class="buttons">
                    <button class="btn-primary" id="downloadBtn" style="display: none;">‚¨áÔ∏è Download Markdown</button>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>‚ú® Processamento seguro 100% local | Sem coleta de dados | Powered by WcAlEldA</p>
            <p style="margin-top: 10px; font-size: 0.9em; color: #999;">Google Cloud Vision API integrada para OCR Premium</p>
        </div>
    </div>

    <!-- Modal de Privacidade -->
    <div class="modal" id="privacyModal">
        <div class="modal-content">
            <span class="modal-close" onclick="document.getElementById('privacyModal').classList.remove('active')">√ó</span>
            <h2>üîê Sua Privacidade √© Nossa Prioridade</h2>
            <p style="margin-top: 20px; line-height: 1.8;">
                <strong>‚úÖ 100% Seguro e Privado:</strong><br>
                ‚Ä¢ Processamento completamente local no seu navegador<br>
                ‚Ä¢ Nenhum arquivo √© enviado para servidor externo<br>
                ‚Ä¢ OCR com Google Cloud Vision processa no backend seguro<br>
                ‚Ä¢ Dados n√£o s√£o armazenados ou registrados<br>
                ‚Ä¢ Sem cookies de rastreamento<br>
                ‚Ä¢ Sem coleta de dados pessoais<br>
            </p>
            <p style="margin-top: 15px; line-height: 1.8;">
                <strong>üìä Como Funciona:</strong><br>
                1. Voc√™ seleciona arquivos PDF/DOCX<br>
                2. Sistema processa localmente no seu navegador<br>
                3. Google Cloud Vision l√™ o conte√∫do (backend seguro)<br>
                4. Resultado √© gerado em Markdown<br>
                5. Voc√™ faz download - tudo √© deletado<br>
            </p>
            <p style="margin-top: 15px; line-height: 1.8;">
                <strong>üõ°Ô∏è Prote√ß√£o T√©cnica:</strong><br>
                ‚Ä¢ HTTPS criptografado<br>
                ‚Ä¢ Credenciais protegidas no servidor<br>
                ‚Ä¢ Nenhuma requisi√ß√£o de upload para servidores terceiros<br>
                ‚Ä¢ C√≥digo open-source (audit√°vel)<br>
            </p>
        </div>
    </div>

    <script>
        // Configura√ß√£o
        const MAX_FILE_SIZE = Infinity; // Ilimitado
        const CHUNK_SIZE = 3 * 1024 * 1024; // 3MB
        const MAX_PAGES_PER_CHUNK = 10;

        // Estado
        let files = [];
        let markdownContent = '';
        let processingQueue = [];
        let isProcessing = false;

        // Elementos
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileList = document.getElementById('fileList');
        const convertBtn = document.getElementById('convertBtn');
        const clearBtn = document.getElementById('clearBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const preview = document.getElementById('preview');
        const progressSection = document.getElementById('progressSection');
        const progressFill = document.getElementById('progressFill');
        const statusText = document.getElementById('statusText');
        const privacyBadge = document.getElementById('privacyBadge');
        const privacyModal = document.getElementById('privacyModal');

        // Event Listeners
        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
        uploadArea.addEventListener('drop', handleDrop);
        fileInput.addEventListener('change', handleFileSelect);
        convertBtn.addEventListener('click', convertFiles);
        clearBtn.addEventListener('click', clearAll);
        downloadBtn.addEventListener('click', downloadMarkdown);
        privacyBadge.addEventListener('click', () => privacyModal.classList.add('active'));

        // Configurar PDF.js worker
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }

        function handleDrop(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const droppedFiles = e.dataTransfer.files;
            handleFiles(droppedFiles);
        }

        function handleFileSelect(e) {
            handleFiles(e.target.files);
        }

        function handleFiles(newFiles) {
            for (let file of newFiles) {
                if (file.type === 'application/pdf' || file.type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document') {
                    files.push(file);
                }
            }
            updateFileList();
            updateStats();
        }

        function updateFileList() {
            fileList.innerHTML = '';
            files.forEach((file, index) => {
                const size = (file.size / 1024 / 1024).toFixed(2);
                const item = document.createElement('div');
                item.className = 'file-item';
                item.innerHTML = `
                    <div class="file-info">
                        <div class="file-name">${file.name}</div>
                        <div class="file-size">${size} MB</div>
                    </div>
                    <button class="file-remove" onclick="removeFile(${index})">√ó</button>
                `;
                fileList.appendChild(item);
            });
        }

        function removeFile(index) {
            files.splice(index, 1);
            updateFileList();
            updateStats();
        }

        function updateStats() {
            document.getElementById('fileCount').textContent = files.length;
            const totalSize = (files.reduce((sum, f) => sum + f.size, 0) / 1024 / 1024).toFixed(2);
            document.getElementById('totalSize').textContent = totalSize + ' MB';
            document.getElementById('statusIcon').textContent = files.length > 0 ? '‚úÖ' : '‚è≥';
        }

        function showStatus(message, type = 'info') {
            progressSection.classList.add('active');
            statusText.textContent = message;
            statusText.className = `status-text ${type}`;
        }

        function updateProgress(current, total) {
            const percent = Math.round((current / total) * 100);
            progressFill.style.width = percent + '%';
            progressFill.textContent = percent + '%';
        }

        async function convertFiles() {
            if (files.length === 0) {
                showStatus('‚ùå Selecione arquivos primeiro', 'error');
                return;
            }

            convertBtn.disabled = true;
            isProcessing = true;
            markdownContent = '';
            preview.textContent = '';
            downloadBtn.style.display = 'none';

            try {
                // Criar fila de processamento
                let totalBlocks = 0;
                processingQueue = [];

                for (let file of files) {
                    const chunks = Math.ceil(file.size / CHUNK_SIZE);
                    for (let i = 0; i < chunks; i++) {
                        processingQueue.push({
                            file: file,
                            chunkIndex: i,
                            totalChunks: chunks
                        });
                        totalBlocks++;
                    }
                }

                showStatus(`üì¶ ${totalBlocks} bloco(s) detectado(s) para processar...`, 'info');

                // Processar blocos
                let processedBlocks = 0;
                for (let blockInfo of processingQueue) {
                    if (!isProcessing) break;

                    const { file, chunkIndex, totalChunks } = blockInfo;
                    const blockNum = ++processedBlocks;

                    showStatus(`‚è≥ Bloco ${blockNum}/${totalBlocks} de "${file.name}" (${chunkIndex + 1}/${totalChunks})`, 'info');
                    updateProgress(processedBlocks, totalBlocks);

                    try {
                        // Extrair conte√∫do
                        let content = '';

                        if (file.type === 'application/pdf') {
                            content = await extractPDF(file, chunkIndex, totalChunks);
                        } else if (file.type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document') {
                            content = await extractDOCX(file);
                        }

                        if (content) {
                            markdownContent += `\n## ${file.name} (Bloco ${chunkIndex + 1}/${totalChunks})\n\n${content}\n`;
                            preview.textContent = markdownContent.substring(0, 1500);
                        }

                    } catch (error) {
                        console.error('Erro ao processar bloco:', error);
                        showStatus(`‚ö†Ô∏è Erro no bloco ${blockNum}: ${error.message}`, 'warning');
                    }

                    await new Promise(resolve => setTimeout(resolve, 100));
                }

                if (markdownContent.trim()) {
                    // Adicionar header
                    const header = `# Documento Unificado **Processado por Facilitador**\nData: ${new Date().toLocaleDateString('pt-BR')}\n\n---\n`;
                    markdownContent = header + markdownContent;
                    preview.textContent = markdownContent;
                    downloadBtn.style.display = 'block';
                    showStatus(`‚úÖ Convers√£o completa! ${totalBlocks} bloco(s) processado(s).`, 'success');
                } else {
                    showStatus('‚ùå Nenhum conte√∫do foi extra√≠do', 'error');
                }

            } catch (error) {
                showStatus(`‚ùå Erro: ${error.message}`, 'error');
                console.error(error);
            } finally {
                convertBtn.disabled = false;
                isProcessing = false;
            }
        }

        async function extractPDF(file, chunkIndex, totalChunks) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;

            const startPage = chunkIndex * MAX_PAGES_PER_CHUNK;
            const endPage = Math.min(startPage + MAX_PAGES_PER_CHUNK, pdf.numPages);

            let text = '';

            for (let pageNum = startPage + 1; pageNum <= endPage; pageNum++) {
                try {
                    const page = await pdf.getPage(pageNum);
                    
                    // Tentar extra√ß√£o direta
                    const textContent = await page.getTextContent();
                    let pageText = textContent.items.map(item => item.str).join(' ');

                    // Se texto vazio, usar OCR com Google Vision
                    if (!pageText || pageText.trim().length < 50) {
                        showStatus(`üì∏ Ativando OCR Google Vision para p√°gina ${pageNum}...`, 'info');
                        pageText = await ocrPageWithGoogleVision(page) || pageText;
                    }

                    text += pageText + '\n';
                } catch (error) {
                    console.error(`Erro na p√°gina ${pageNum}:`, error);
                }
            }

            return cleanText(text);
        }

        async function ocrPageWithGoogleVision(page) {
            try {
                // Renderizar p√°gina para imagem
                const canvas = document.createElement('canvas');
                const viewport = page.getViewport({ scale: 2 });
                canvas.width = viewport.width;
                canvas.height = viewport.height;

                const context = canvas.getContext('2d');
                await page.render({ canvasContext: context, viewport }).promise;

                // Converter para base64
                const imageData = canvas.toDataURL('image/jpeg');
                const base64 = imageData.split(',')[1];

                // Enviar para backend Google Vision
                const response = await fetch('/api/ocr', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ imageBase64: base64 })
                });

                const data = await response.json();

                if (data.success && data.text) {
                    showStatus(`‚úÖ OCR Google Vision: ${data.length} caracteres extra√≠dos`, 'success');
                    return data.text;
                } else {
                    // Fallback para Tesseract
                    return await ocrPageWithTesseract(canvas);
                }

            } catch (error) {
                console.error('Erro Google Vision, usando Tesseract:', error);
                // Fallback
                const canvas = document.createElement('canvas');
                const page = page;
                const viewport = page.getViewport({ scale: 2 });
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                const context = canvas.getContext('2d');
                await page.render({ canvasContext: context, viewport }).promise;
                return await ocrPageWithTesseract(canvas);
            }
        }

        async function ocrPageWithTesseract(canvas) {
            try {
                showStatus('üì∏ Processando com Tesseract.js...', 'info');
                const { data: { text } } = await Tesseract.recognize(
                    canvas.toDataURL('image/jpeg'),
                    'por+eng'
                );
                return text;
            } catch (error) {
                console.error('Erro Tesseract:', error);
                return '';
            }
        }

        async function extractDOCX(file) {
            const arrayBuffer = await file.arrayBuffer();
            try {
                const result = await mammoth.extractRawText({ arrayBuffer });
                return result.value;
            } catch (error) {
                console.error('Erro ao extrair DOCX:', error);
                return '';
            }
        }

        function cleanText(text) {
            if (!text) return '';

            let cleaned = text.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g, '');
            cleaned = cleaned.replace(/[^\w\s.,;:!?()\-‚Äî‚Äì'""''`@#$/‚Ç¨¬£¬•%&+=*/\[\]{}√†√°√¢√£√§√•√®√©√™√´√¨√≠√Æ√Ø√≤√≥√¥√µ√∂√π√∫√ª√º√Ω√ø√±√ß√Å√Ä√Ç√É√Ñ√Ö√â√à√ä√ã√ç√å√é√è√ì√í√î√ï√ñ√ö√ô√õ√ú√ù]/g, ' ');

            const lines = cleaned.split('\n');
            const validLines = lines.filter(line => {
                const trimmed = line.trim();
                if (trimmed.length < 2) return false;
                const alphanumeric = trimmed.replace(/[^a-zA-Z0-9]/g, '');
                return alphanumeric.length > 0;
            });

            cleaned = validLines.join('\n');
            cleaned = cleaned.replace(/\s+/g, ' ');
            cleaned = cleaned.replace(/\n\s*\n/g, '\n\n');

            return cleaned.trim();
        }

        function downloadMarkdown() {
            const element = document.createElement('a');
            element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(markdownContent));
            element.setAttribute('download', `facilitador-${Date.now()}.md`);
            element.style.display = 'none';
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
            showStatus('‚úÖ Download iniciado!', 'success');
        }

        function clearAll() {
            files = [];
            markdownContent = '';
            preview.textContent = '';
            downloadBtn.style.display = 'none';
            fileList.innerHTML = '';
            fileInput.value = '';
            progressSection.classList.remove('active');
            updateStats();
            showStatus('üóëÔ∏è Tudo foi limpo', 'info');
        }
    </script>
</body>
</html>
